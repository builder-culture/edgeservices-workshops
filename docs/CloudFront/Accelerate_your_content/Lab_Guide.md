## Create EC2 & S3 origins

In this section, you will create both S3 and EC2 origin using a provided CloudFormation template.

1.- Go to _CloudFormation_ console in **US East (N. Virginia)** _us-east-1_ region.

![accelerate_origin_1a](/assets/images/cloudfront/accelerate_origin_1a.png)

<br/>

And then click  **Create stack**.

![accelerate_origin_1b](/assets/images/cloudfront/accelerate_origin_1b.png)

<br/>

2.- Choose **Template is ready** and **Upload a template file**, then choose and upload the following template file. Click on **Next** button. 
  
 * [_cloudfront-lab.yaml_](https://s3.amazonaws.com/edge-services-immersion-day-lab-artifacts/cloudfront-lab.yaml)
  
![accelerate_origin_2](/assets/images/cloudfront/accelerate_origin_2.png)

<br/>

3.- Enter a name for your stack (e.g. `CloudFrontLab`) and click **Next**; and again click **Next** button on _Configure stack options_ steps. 
![accelerate_origin_3](/assets/images/cloudfront/accelerate_origin_3.png)

<br/>

Finally on _Review_ step click the **Create stack** button.

![accelerate_origin_3b](/assets/images/cloudfront/accelerate_origin_3b.png)

<br/>

4.- Wait some minutes to see on _Stack Info_ section the **CREATE_COMPLETE** _Status_. 

![accelerate_origin_4a](/assets/images/cloudfront/accelerate_origin_4a.png)

<br/>

Then, when the launch is completed, go to the _Outputs_ Tab.

!!! note "Take note of the following values"
     On _Outputs_ Tab note the Domain Name _Value_ (also know as **Public DNS**) of your EC2 based web server, as well as the autogenerated S3 bucket name. <br/><br/>
     **Important: You are going to need them to complete further steps.**

![accelerate_origin_4b](/assets/images/cloudfront/accelerate_origin_4b.png)

<br/>

??? tip 
    During stack launch process, you can check progress via _Events_ Tab and get more details for debugging in case of any problem.
    
    ![accelerate_origin_4c](/assets/images/cloudfront/accelerate_origin_4c.png)

<br/>

5.- Create an _index.html_ file on your computer with the below HTML content. Or <a href="/assets/files/accelerate/index.html" download>click here to download</a>.
 
``` html  
<!DOCTYPE html>
<html lang="en">
  <body>
    <table border="1" width="100%">
    <thead>
        <tr><td><h1>CloudFront Lab</h1></td></tr>
    </thead>
    <tfoot>
        <tr><td>Immersion Days - Edge Services - Module 1</td></tr>
    </tfoot>
    <tbody>
        <tr><td>Response sent by API</td></tr>
    </tbody>
    <tbody>
        <tr><td> 
          <iframe src='/api' style="width:100%; height:100%;"></iframe>
        </td></tr>
    </tbody>
    </table>
  </body>
</html>
```

!!! info 
    This HTML calls the dynamic content using an iframe tag. Therefore, when a user makes a request for _index.html_, the browser sends a subsequent request to _/api_.

<br/>

6.- Go to _S3_ console. 

![accelerate_origin_6a](/assets/images/cloudfront/accelerate_origin_6a.png)

<br/>

Find the S3 bucket created by CloudFormation (using the name you have noted on step 4); and click on it.

![accelerate_origin_6b](/assets/images/cloudfront/accelerate_origin_6b.png)

<br/>

**Upload** to this S3 bucket the _index.html_ file leaving all settings to default.

![accelerate_origin_6c](/assets/images/cloudfront/accelerate_origin_6c.png)

<br/>

![accelerate_origin_6d](/assets/images/cloudfront/accelerate_origin_6d.png)

<br/>

7.- Click on the listed _index.html_ and get its details.

![accelerate_origin_7a](/assets/images/cloudfront/accelerate_origin_7a.png)

<br/>

Try to request _index.html_ using the S3 provided **Object URL**.

![accelerate_origin_7b](/assets/images/cloudfront/accelerate_origin_7b.png)

<br/>

The access will be denied since it's not configured as public object.

![accelerate_origin_7c](/assets/images/cloudfront/accelerate_origin_7c.png)

<br/>

8.- The _CloudFormation template_ has deployed a Node.Js based application that listens to HTTP requests on port 80 of the EC2 instance. Make sure the application work by going requesting ```http://<EC2_Instance_Public_DNS>/api``` (using the __Public DNS__ you have noted on step 4).  You should see the below screen in your browser. 

![accelerate_origin_8a](/assets/images/cloudfront/accelerate_origin_8a.png)

??? tip 
    You can obtain _also_ the EC2 Instance _Domain Name_ or **Public DNS** from _EC2_ console.

    ![accelerate_origin_8b](/assets/images/cloudfront/accelerate_origin_8b.png)


The node.js application code is simply the below:

``` javascript
const express = require('express')
const app = express()

app.get('/api', function (req, res) {
  console.log(JSON.stringify(req.headers))
  if (req.query.info) {
    require('child_process').exec('cat '+ req.query.info,
      function (err, data) {
        res.send(new Date().toISOString() + '\n' 
          + JSON.stringify(req.headers) + '\n'+ data)
      });
  } else {
    res.send(new Date().toISOString() 
              + '\n' + JSON.stringify(req.headers))
  }
});

app.listen(8080, function () {
  console.log('api is up!')
})
```

!!! info 
    Upon receiving a request, the application will send back a json response that includes the headers received in the request. It will also inspect the query string info and return some data from the webserver based on the query string value. 


<br/>

## Create CloudFront Distribution

1.- Go to _CloudFront_ console and create a new distribution. If this is your first time to use CloudFront, click on **Create Distribution** in the Getting Started page. 
 
![accelerate_distribution_1a](/assets/images/cloudfront/accelerate_distribution_1a.png) 

<br>

Otherwise, you can **Get Started** with a Web distribution.

![accelerate_distribution_1b](/assets/images/cloudfront/accelerate_distribution_1b.png) 

<br/>

2.- Configure the _Origin Settings_ to the previously created S3 bucket and grant CloudFront the permissions to the bucket using Origin Access Identity settings:

*	Origin Domain Name : `<Autogenerated_S3_Bucket_Name>`
*	Restrict Bucket Access : **Yes**
*	Origin Access Identity :  **Create a new Identity**
*	Grant Read Permissions on Bucket : **Yes, Update Bucket policy**
 
![accelerate_distribution_2](/assets/images/cloudfront/accelerate_distribution_2.png) 

<br/>

3.- Configure the _Default Cache Behavior Settings_ to below

*	Viewer Protocol Policy : **Redirect HTTP to HTTPS**
*	Object Caching : **Customize** 
    * Minimum TTL : ```86400```
*	Compress Objects Automatically : **Yes**
 
![accelerate_distribution_3a](/assets/images/cloudfront/accelerate_distribution_3a.png) 

<br/>

Configure root object to _index.html_ and leave the rest to defaults. 

!!! info
    In this lab, you will be using a domain name provided by CloudFront, however, if you want to use your own domain name, you can configure it with Alternate Domain Names (CNAMEs) section.

![accelerate_distribution_3c](/assets/images/cloudfront/accelerate_distribution_3b.png) 

<br/>

Click **Create Distribution**, CloudFront start creating the distribution and normally it takes 10 to 20 mins to fully propagate. 

![accelerate_distribution_3c](/assets/images/cloudfront/accelerate_distribution_3c.png) 

<br/>

4.- To check the status, you need to click on the _Distribution_ menu on left pane. The _Status_ of the distribution will be **In Progress**. 

![accelerate_distribution_4](/assets/images/cloudfront/accelerate_distribution_4.png) 

Wait some minutes until its _Status_ changes to **Deployed**

<br/>

5.- In the same CloudFront _Distributions_ console, click on your recently created Distribution **ID**, then go to _Origins and Origin Groups_ Tab. To create another origin for the _api_, on the _Origins_ section click the **Create Origin** button .
 
![accelerate_distribution_5](/assets/images/cloudfront/accelerate_distribution_5.png) 

<br/>

6.- Configure the _Origin Settings_ using EC2 instance domain name (_Public DNS_), and increase keep alive timeout to 60 seconds. Please note that although we want to serve content on HTTPS to users, we want to keep HTTP connection the origin to reduce the TLS overhead on the origin. This is configured by setting the  Origin Protocol Policy to HTTP only as per the below screenshot.

* Origin Domain Name : ```<EC2_Instance_Public_DNS>```
* Origin Protocol Policy : **HTTP Only**
* Origin Keep-alive Timeout : ```60```

Review the configuration, then click on **Create** button.

![accelerate_distribution_6](/assets/images/cloudfront/accelerate_distribution_6.png) 

<br/>

7.- Create a new behaviour for the _api_. Select _Behaviors_ tab, and then click on **Create Behavior** button.
 
![accelerate_distribution_7](/assets/images/cloudfront/accelerate_distribution_7.png) 

<br/>

8.- Configure a second cache behaviour to use the EC2 origin with following parameters to use CloudFront as proxy and bypass any caching layers.

*	Path Pattern : `/api`
* Origin or Origin Group : `<Created_EC2_Custom_Origin>`
*	Viewer Protocol Policy : **Redirect HTTP to HTTPS**
*	Cache Based on Selected Headers: **All**
*	Forward Cookies : **All**
*	Query String Forwarding and Caching : **Forward all, cache based on all**
*	Compress Objects Automatically : **Yes**

![accelerate_distribution_8a](/assets/images/cloudfront/accelerate_distribution_8a.png) 

Review the configuration, then click on **Create** button.

![accelerate_distribution_8b](/assets/images/cloudfront/accelerate_distribution_8b.png) 

<br/>

9.- Check and note the unique **Domain Name** that CloudFront has associated to your distribution in the _General_ tab.
 
![accelerate_distribution_9](/assets/images/cloudfront/accelerate_distribution_9.png) 

<br/>

## Test the application on CloudFront

1.- CloudFront distribution can be ready to be used locally even if the status is still in progress, since the status will change to deployed when the propagation has reached all 176 edge locations. To test if the distribution is ready to be used locally, you can lookup its CloudFront domain name in command line by nslookup command. Keep in mind that _dxxxx.cloudfront.net_ name is unique for every distribution, this is why need to use your own distribution value for testing. Note how CloudFront returns multiple IPs for each DNS query to increase application resiliency.
 
![accelerate_test_1](/assets/images/cloudfront/accelerate_test_1.png) 

<br/>

2.- When the propagation is done, you can test the webpage on your browser as served by CloudFront using _http://dxxxx.cloudfront.net_. In the webpage, you can see the different headers that CloudFront has forwarded and appended to your API endpoint:

*	**cloudfront-forwarded-proto** : Indicates the protocol used by the viewer to connect to CloudFront
*	**cloudfront-is-mobile-viewer** : Indicates the viewer's device type
*	**cloudfront-viewer-country** : Indicates the viewer's country
*	**x-amz-cf-id** : a unique id for this request provided by CloudFront. If you refresh the webpage, you will see that how the request id is changing. It's useful to log it on your webserver in general. Additionally, this id will be sent back to every viewer request and sent to _CloudFront Access Logs_. If you need to debug any issue you can open a support ticket and provide them with the request id (_x-amz-cf-id_). Also note how CloudFront redirected the request to HTTPS.

![accelerate_test_2](/assets/images/cloudfront/accelerate_test_2.png) 

<br/>

3.- If you use the developper tools of your favorite web browser, you can check the response headers sent by CloudFront. Three headers are interesting to check:

*	**x-amz-cf-id** : which holds the request id assigned by CloudFront.
*	**x-amz-cf-pop** : which indicates the CloudFront edge location that served your request. Each edge location is identified by a three-letter code and an arbitrarily assigned number, for example, DFW3. The three-letter code typically corresponds with the International Air Transport Association airport code for an airport near the edge location.
*	**x-cache** : which indicates whether the request was a cache hit or a cache miss. Normally, for your html file, you will get a 'Hit from Cloudfront' value in the subsequent requests, but always 'Miss from CloudFront' for /api request since caching is disabled for this behaviour.
 
![accelerate_test_1](/assets/images/cloudfront/accelerate_test_3.png) 

<br/>

## Test invalidations

As you saw previously, the main _index.html_ page is in cache and resulting in a Hit from CloudFront. Suppose that you have to change the HTML file but you can't change URL to point to the new version, in this case, you need to invalidate the page. 

1.- Go to the _Invalidations_ Tab

![accelerate_invalidations_1](/assets/images/cloudfront/accelerate_invalidations_1.png) 

<br/>

2.- Create an invalidation for your _index.html_. You can specify ```/``` in the Object paths because we already set _index.html_ as default root object. Cick on **Invalidate** button.

![accelerate_invalidations_2](/assets/images/cloudfront/accelerate_invalidations_2.png)  

<br/>

3.- After a few of seconds, test again the page using the browser developer tool, and you'll find that it resulted in a cache miss.

![accelerate_invalidations_3](/assets/images/cloudfront/accelerate_invalidations_3.png) 

<br/>

## Configure custom error page

In this section, you will configure a custom error page for graceful failures if the requested content is not found.

1.- Test a random URL using your CloudFront domain name and you will get a 403 Forbidden response from S3 behind CloudFront because the file does not exist. By default, CloudFront caches this response for 5 minutes.

![accelerate_errorpage_1](/assets/images/cloudfront/accelerate_errorpage_1.png) 

<br/>

2.- Create _error.html_ file on your computer with the below HTML content (Or <a href="/assets/files/accelerate/error.html" download>click here to download</a>).

``` html
<html lang="en">
  <body>
    <h1>CloudFront Lab</h1>
    Oups, this is a nice error page!
  </body>
</html>
```

<br/>

Go back to your S3 bucket in the _S3_ console, and upload the _error.html_ file to it.

![accelerate_errorpage_2](/assets/images/cloudfront/accelerate_errorpage_2.png) 

<br/>

3.- In _CloudFront_ console, on your same CloudFront _Distribution, _go to _Error Pages_ Tab and click **Create Custom Error Response** button.
 
![accelerate_errorpage_3](/assets/images/cloudfront/accelerate_errorpage_3.png) 

<br/>

4.- Configure custom error response with the following settings.

*	HTTP Error Code : **403 Forbidden**
*	Error Cacching Minimum TTL (seconds) : `60`
*	Customize Error Response : **Yes**
*	Response Error Response : `/error.html`
*	HTTP Response Code : **200 OK**
 
Review the configuration, then click on **Create** button.

![accelerate_errorpage_4](/assets/images/cloudfront/accelerate_errorpage_4.png) 

<br/>

5.- Test your custom error page, by requesting a random page from CloudFront. You may need a few minutes to wait for distribution to update and propagate to edge locations. Make sure that you use a different random value from the previous test, other wise you will get the same cached version if you test within 5 mins.
 
![accelerate_errorpage_5](/assets/images/cloudfront/accelerate_errorpage_5.png) 

<br/>

6.- Create another custom error page that will be triggered when the origin is not reachable by CloudFront. Use the following settings:

*	HTTP Error Code : **504 Gateway Timeout**
*	Error Caching Minimum TTL (seconds) : `5`
*	Customize Error Response : **Yes**
*	Response Error Response : `/error.html`
*	HTTP Response Code : **200 OK**
 
![accelerate_errorpage_6](/assets/images/cloudfront/accelerate_errorpage_6.png) 

Review the configuration, then click on **Create** button.

<br/>

7.- Go to the _EC2_ console. 

![accelerate_errorpage_7a](/assets/images/cloudfront/accelerate_errorpage_7a.png) 

<br/>

Find the _running instance_ which is hosting the Nodejs api.

![accelerate_errorpage_7b](/assets/images/cloudfront/accelerate_errorpage_7b.png) 

<br/>

**Stop** the EC2 instance.

![accelerate_errorpage_7c](/assets/images/cloudfront/accelerate_errorpage_7c.png) 

<br/>

8.- Test again your index.html and wait until the API call fails gracefully to the custom error page.

![accelerate_errorpage_8](/assets/images/cloudfront/accelerate_errorpage_8.png)  

<br/>

## Conclusion

!!! success 
    Congrats you have completed the Lab of CloudFront module. You have learned how to create a distribution with multiple origins and multiple behaviors that delivers static content and proxies api dynamic content to your origin.  You have also learned how to set up custom error pages and invalidate content quickly. Finally, you have learned about some important CloudFront headers for debugging.